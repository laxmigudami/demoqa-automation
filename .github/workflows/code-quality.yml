name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Black (check only)
      run: |
        black --check --line-length=120 .
      continue-on-error: false
    
    - name: Run isort (check only)
      run: |
        isort --check-only --profile=black --line-length=120 .
      continue-on-error: false
    
    - name: Run Flake8
      run: |
        flake8 . --max-line-length=120 --statistics
      continue-on-error: false
    
    - name: Run Pylint
      run: |
        pylint config pages utils features/steps --output-format=text --score=yes
      continue-on-error: true  # Don't fail on warnings
    
    - name: Run Bandit (security)
      run: |
        bandit -r config pages utils features/steps -f json -o bandit-report.json
      continue-on-error: true
    
    - name: Upload Bandit report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
    
    - name: Run comprehensive quality check
      run: |
        python run_code_quality.py
      continue-on-error: false
    
    - name: Upload quality reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-quality-reports
        path: code_quality_reports/

  test-execution:
    name: Test Execution
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Chrome
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: Install ChromeDriver
      uses: nanasess/setup-chromedriver@master
    
    - name: Run tests (headless)
      env:
        HEADLESS: "true"
      run: |
        python run_tests.py
      continue-on-error: false
    
    - name: Upload test reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports
        path: reports/
    
    - name: Upload logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-logs
        path: logs/
